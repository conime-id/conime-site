rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ARTICLES
    match /articles/{articleId} {
      allow read: if true;
      
      // Allow create/delete only for admins
      allow create, delete: if request.auth != null && request.auth.token.admin == true;

      // UPDATE RULES:
      // 1. Admin can update anything.
      // 2. Public (Guest) can ONLY increment views.
      // 3. Authenticated User can ONLY increment likes (views are handled by public rule, but separate is cleaner).
      allow update: if 
        (request.auth != null && request.auth.token.admin == true) ||
        (
          // Public: Allow update if ONLY 'views' changed
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['views'])
        ) ||
        (
          // Authenticated: Allow update if ONLY 'likes' changed
          request.auth != null &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['likes'])
        );
    }

    // USERS
    match /users/{userId} {
      // Allow users to read and write ONLY their OWN data
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // COMMENTS
    match /comments/{commentId} {
      allow read: if true;
      
      // Create: Must be logged in, and owner field must match uid
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      
      // Update/Delete: Must be owner
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}
