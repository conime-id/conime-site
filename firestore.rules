rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      // Check if the user document has role == 'admin'
      // Note: This requires an extra read, which costs money/quota.
      // Optimally, Custom Claims in Auth Token are better, but Firestore read is easier for now.
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- Users Collection ---
    match /users/{userId} {
      allow read: if true; // Public profiles
      
      // Allow create if auth matches ID and role is 'user' (default)
      allow create: if isOwner(userId) 
        && request.resource.data.role == 'user'; // Prevent creating as admin
      
      // Allow update if owner, BUT prevents changing the 'role' field
      allow update: if isOwner(userId) 
        && request.resource.data.role == resource.data.role; 
      
      allow delete: if isOwner(userId) || isAdmin();
    }

    // --- Comments Collection ---
    match /comments/{commentId} {
      allow read: if true;
      
      allow create: if isSignedIn() 
        && request.resource.data.userId == request.auth.uid;
        
      allow update: if (isOwner(resource.data.userId) || isAdmin())
        // Prevent changing ownership
        && request.resource.data.userId == resource.data.userId; 
        
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    // --- Articles Collection ---
    // (Used for Likes & Views counters)
    match /articles/{articleId} {
      allow read: if true;
      
      // Admins/Editors can do full writes
      allow create, delete: if isAdmin(); // Add isEditor() if needed
      
      // Update logic:
      // 1. Admin/Editor can update everything.
      // 2. Public can increment 'views' ONLY.
      // 3. Authenticated users can increment 'likes' and 'views'.
      allow update: if isAdmin() 
        || (
           // Case A: Updating Views (Allowed for Everyone)
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views'])
        )
        || (
           // Case B: Updating Likes (Allowed for Signed In Users)
           isSignedIn() &&
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes'])
        );
    }
  }
}
